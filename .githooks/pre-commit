#!/bin/bash
# Pre-commit hook: Normalize team-specific signing settings in pbxproj files
# This prevents accidental commits of personal team IDs and signing identities
#
# With CODE_SIGN_STYLE = Automatic, Xcode manages signing via xcuserdata (gitignored).
# This hook ensures no team-specific settings leak into the repository.

# Use while read loop with null-terminated strings for safe filename handling
while IFS= read -r -d '' pbxproj; do
    modified=false
    tmpfile="$(mktemp)"

    # Start with current file content
    cp "$pbxproj" "$tmpfile"

    # Strip DEVELOPMENT_TEAM lines (personal team IDs)
    if grep -q 'DEVELOPMENT_TEAM' "$tmpfile"; then
        echo "Stripping DEVELOPMENT_TEAM from $pbxproj"
        sed '/DEVELOPMENT_TEAM/d' "$tmpfile" > "$tmpfile.new" && mv "$tmpfile.new" "$tmpfile"
        modified=true
    fi

    # Strip SDK-specific CODE_SIGN_IDENTITY lines (e.g., [sdk=iphoneos*])
    if grep -q 'CODE_SIGN_IDENTITY\[sdk=' "$tmpfile"; then
        echo "Stripping SDK-specific CODE_SIGN_IDENTITY from $pbxproj"
        sed '/CODE_SIGN_IDENTITY\[sdk=/d' "$tmpfile" > "$tmpfile.new" && mv "$tmpfile.new" "$tmpfile"
        modified=true
    fi

    # Normalize CODE_SIGN_IDENTITY to ad-hoc signing ("-")
    if grep -q 'CODE_SIGN_IDENTITY = "Apple Development"' "$tmpfile"; then
        echo "Normalizing CODE_SIGN_IDENTITY to ad-hoc in $pbxproj"
        sed 's/CODE_SIGN_IDENTITY = "Apple Development"/CODE_SIGN_IDENTITY = "-"/g' "$tmpfile" > "$tmpfile.new" && mv "$tmpfile.new" "$tmpfile"
        modified=true
    fi

    # Apply changes if any modifications were made
    if [ "$modified" = true ]; then
        if mv "$tmpfile" "$pbxproj"; then
            git add "$pbxproj"
        else
            echo "Error: failed to update $pbxproj" >&2
            rm -f "$tmpfile" "$tmpfile.new"
            exit 1
        fi
    else
        rm -f "$tmpfile" "$tmpfile.new"
    fi
done < <(git diff --cached --name-only -z -- '*.pbxproj')
