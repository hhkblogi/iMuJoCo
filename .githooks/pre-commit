#!/bin/bash
# Pre-commit hook: Normalize team-specific signing settings in pbxproj files
# This prevents accidental commits of personal team IDs
#
# DEVELOPMENT_TEAM is set to $(DEVELOPMENT_TEAM) which resolves from local.xcconfig
# This hook normalizes any hardcoded team IDs back to the variable reference.

# Use while read loop with null-terminated strings for safe filename handling
while IFS= read -r -d '' pbxproj; do
    modified=false
    tmpfile="$(mktemp)"

    # Start with current file content
    cp "$pbxproj" "$tmpfile"

    # Normalize DEVELOPMENT_TEAM to variable reference (replace hardcoded team IDs)
    # Matches: DEVELOPMENT_TEAM = XXXXX; or DEVELOPMENT_TEAM = "XXXXX";
    # But NOT: DEVELOPMENT_TEAM = "$(DEVELOPMENT_TEAM)";
    if grep -q 'DEVELOPMENT_TEAM = ' "$tmpfile" && grep -v '\$(DEVELOPMENT_TEAM)' "$tmpfile" | grep -q 'DEVELOPMENT_TEAM = '; then
        echo "Normalizing DEVELOPMENT_TEAM to variable in $pbxproj"
        sed 's/DEVELOPMENT_TEAM = "[^$][^"]*";/DEVELOPMENT_TEAM = "$(DEVELOPMENT_TEAM)";/g; s/DEVELOPMENT_TEAM = [^"$][^";]*;/DEVELOPMENT_TEAM = "$(DEVELOPMENT_TEAM)";/g' "$tmpfile" > "$tmpfile.new" && mv "$tmpfile.new" "$tmpfile"
        modified=true
    fi

    # Apply changes if any modifications were made
    if [ "$modified" = true ]; then
        if mv "$tmpfile" "$pbxproj"; then
            git add "$pbxproj"
        else
            echo "Error: failed to update $pbxproj" >&2
            rm -f "$tmpfile" "$tmpfile.new"
            exit 1
        fi
    else
        rm -f "$tmpfile" "$tmpfile.new"
    fi
done < <(git diff --cached --name-only -z -- '*.pbxproj')
